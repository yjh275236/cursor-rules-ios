---
alwaysApply: false
---
# Serena 工作流程指南

## 🎯 判断逻辑：何时使用Serena

**先判断任务类型，再决定使用哪种工具。**

### 使用Serena更有优势的情况

以下情况应优先使用Serena工具链：

1. **大型代码库操作**
   - 需要在整个代码库中精确查找符号
   - 需要分析符号之间的引用关系
   - 需要理解代码架构和模块依赖
   - 需要跨多个文件进行代码分析

2. **符号级别操作**
   - 重命名符号（类、方法、属性等）
   - 查找符号的所有引用位置
   - 需要符号的完整定义和上下文
   - 需要分析符号的调用关系

3. **复杂重构任务**
   - 跨多个文件的修改
   - 需要保持代码结构一致性
   - 需要分析影响范围
   - 需要确保重构后代码的正确性

### 跳过Serena，使用普通工具的情况

以下情况应使用普通工具（read_file、search_replace、grep等）：

1. **简单任务**
   - 单文件内的简单编辑
   - 简单的查找替换
   - 添加注释或文档
   - 修改配置值

2. **非代码文件**
   - 配置文件（plist、json、yaml等）
   - 文档文件（md、txt等）
   - 资源文件
   - 脚本文件

3. **创建新文件**
   - 创建全新的代码文件
   - 创建配置文件
   - 创建文档

---

## ⚡ 操作步骤（仅在确定使用Serena时执行）

### 1. 初始化（仅在首次使用Serena时）

- 调用 `initial_instructions`
- 调用 `check_onboarding_performed`
- 调用 `read_memory("project_overview")`
- 输出 `✅ 已加载项目记忆：project_overview.md`

### 2. 补充记忆（按需）

- 涉及第三方库/技术栈 → 读取 `tech_stack`
- 涉及代码实现模式 → 读取 `common_patterns`

### 3. 处理任务

- **探索代码**：`get_symbols_overview` → `find_symbol(include_body=false)` → `find_symbol(include_body=true)`
- **修改代码**：
  - 优先 `search_replace`；必要时 `replace_symbol_body` / `insert_after_symbol`；跨文件改名用 `rename_symbol`
  - **必须显示 diff**：每次代码修改后都要展示变更内容，让用户能看到具体的代码更改
- **文件读取**：优先使用 Serena MCP 工具链（`get_symbols_overview`、`find_symbol` 等）探索代码；`read_file` 仅用于：
  - 配置文件（plist、json、yaml 等）
  - 文档文件（md、txt 等）
  - 日志文件
  - 其他非代码文件

---

## 📚 标准记忆文件

**必读**：
- `project_overview.md`

**按需**：
- `tech_stack.md`
- `common_patterns.md`

---

## 🔧 工具使用要点

- **智能判断**：先判断任务类型，再决定使用Serena还是普通工具
- **效率优先**：简单任务使用普通工具，复杂任务使用Serena
- **处理代码时**：如果确定使用Serena，始终首选 Serena MCP 工具链
- **输出或查看 diff**：默认开启，除非用户明确允许跳过
- **任务仅为讨论或建议时**：不要额外触发 Serena 流程

---

## 💡 判断示例

### 示例1：应该使用Serena
- 任务：重命名一个类，并更新所有引用
- 判断：符号级别操作，跨多个文件
- 决策：使用Serena的 `rename_symbol` 工具

### 示例2：应该使用普通工具
- 任务：修改配置文件中的某个值
- 判断：非代码文件，简单编辑
- 决策：使用 `read_file` + `search_replace`

### 示例3：应该使用Serena
- 任务：查找某个方法的所有调用位置
- 判断：需要分析符号引用关系
- 决策：使用Serena的 `find_referencing_symbols` 工具

### 示例4：应该使用普通工具
- 任务：创建新的Swift文件
- 判断：创建新文件
- 决策：使用 `write` 工具直接创建
