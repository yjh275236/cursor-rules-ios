# Cursor Rules 说明

本目录包含 **通用的** AI 辅助开发规则配置，可在多个项目间复用。

> 💡 **特别说明**: 所有规则中的 `{项目名}` 为占位符，AI 会根据当前激活的 Serena MCP 服务器自动识别并替换。

## 📐 核心原则

**alwaysApply: true → 精简高效**
- 始终加载，影响所有对话
- 控制 token 占用（~200 行以内）
- 只保留核心要点和可执行指令

**alwaysApply: false → 详细完整**
- 按需手动触发（使用 `@规则名`）
- 可包含详细模板、示例和决策树
- 作为完整参考指南

---

## 📁 文件结构

```
.cursor/rules/
├── 00-personal.mdc              # 个人编码偏好 [always, 57行]
├── 01-serena-workflow.mdc       # Serena 工作流程 [always, 65行]
├── 02-project-conventions.mdc   # 设计原则与约束 [always, 53行]
├── README.md                    # 本文件
├── tools/                       # 工具类规则 [按需触发]
│   ├── api-integration.mdc      # 接口对接规范 [~500行]
│   ├── problem-handling.mdc     # 问题处理合集 [32行]
│   ├── quick-build.mdc          # 快捷构建命令 [50行]
│   ├── rules-maintenance.mdc    # 规则编写指南 [436行]
│   └── serena-maintenance.mdc   # Serena 维护指南 [775行]
└── XcodeMCP/                    # Xcode MCP 工具 [按需触发]
    ├── xcode-build.mdc          # 构建和运行 [112行]
    └── xcode-log.mdc            # 日志分析 [414行]
```

**统计**：
- 核心规则（Always）：175 行
- 工具规则（按需）：~1793 行
- XcodeMCP 工具：526 行
- 总计：~2494 行

---

## 📋 核心规则详解

### 1. `00-personal.mdc`（57 行）✅ Always

**用途**: 个人编码偏好和工作方式

**核心内容**:
- **回答格式**：简洁优先，必要时说明使用的工具
- **工作方式**：先思考再实现、逐步推理、简明扼要
- **代码质量**：100% 完整性、可读性优先、安全高效
- **诚信原则**：明确不确定性、不猜测

**可复用性**: ✅ 完全可跨项目复用

---

### 2. `01-serena-workflow.mdc`（65 行）✅ Always

**用途**: Serena MCP 工作流程和工具使用规范

**核心内容**:
- **执行条件**：操作代码/分析文件/技术排查 → 启动 Serena
- **强制步骤**：初始化 → 加载记忆 → 使用 Serena 工具
- **🚨 禁止**：直接 `read_file` 读取代码文件
- **工具选择**：
  - 探索：`get_symbols_overview` → `find_symbol`
  - 修改：`search_replace`（首选）
  - 重构：Serena MCP 符号化工具

**可复用性**: ✅ 完全可跨项目复用

---

### 3. `02-project-conventions.mdc`（53 行）✅ Always

**用途**: 设计原则与项目约束

**核心内容**:
- **编码流程**：添加/修改/重构代码前必须分析：
  1. 这段代码的职责是什么？（SRP）
  2. 是通过扩展还是修改实现？（OCP）
  3. 需要依赖哪些抽象接口？（DIP）
- **设计原则**（混合式）：
  - SRP/OCP/DIP：原则 + 具体执行指令
  - ISP/LSP/LoD：简要执行说明
- **强制约束**：
  - 禁止：Controller 直接网络请求、Request 导入 UIKit、全局变量
  - 推荐：Protocol + Extension、值类型优先

**可复用性**: ⚠️ 需根据项目调整（分层规则、类名前缀等）

---

## 🛠️ 工具规则详解

### 1. `tools/api-integration.mdc`（~500 行）❌ 按需触发

**用途**: UI 页面完成后对接真实接口的完整规范  
**触发**: `@api-integration` 或 UI 页面完成后需要接接口时  
**核心内容**:
- 接口对接前检查清单（确认接口信息、检查项目架构）
- Model 创建规范（Codable、字段映射、命名规范）
- 网络请求规范（复用项目封装、参数构建、错误处理）
- UI 状态处理规范（Loading、Success、Error、Empty 四种状态）
- 数据替换规范（删除模拟数据、更新数据绑定）
- 接口对接后验证清单（功能验证、场景测试、代码质量验证）
- 与现有规则的配合（Plan 文档同步、代码清理、架构检查）

**可复用性**: ✅ 完全可跨项目复用

---

### 2. `tools/problem-handling.mdc`（32 行）❌ 按需触发

**用途**: 问题处理合集  
**触发**: `@problem-handling`  
**内容**: 
- 收集 AI 常见错误场景和解决方案
- 双重用途：提高 AI 精准度 + 用户快速查阅
- 当前包含：技术术语沟通规范

**可复用性**: ✅ 完全可跨项目复用

---

### 3. `tools/quick-build.mdc`（50 行）❌ 按需触发

**用途**: 快捷构建和运行 iOS 应用  
**触发**: `@quick-build`  
**功能**: 自动检测项目 → 重启模拟器 → 构建 → 运行

**可复用性**: ✅ 通用 iOS 项目可复用

---

### 4. `tools/rules-maintenance.mdc`（436 行）❌ 按需触发

**用途**: 规则编写与优化指南  
**触发**: `@rules-maintenance` 或用户说"优化规则"

**核心内容**:
- 三大核心原则（可执行性、混合式设计、精简）
- 规则优化检查清单（可执行性、精简性、有效性）
- 模糊词汇黑名单和替换方案
- 强制前置分析技巧
- 规则审核流程（3步法）
- 优化案例库（抽象→可执行、压缩长流程、问题处理合集精简）
- 常见反模式和快速优化流程
- 规则冲突处理和版本管理

**可复用性**: ✅ 完全可跨项目复用

---

### 5. `tools/serena-maintenance.mdc`（775 行）❌ 按需触发

**用途**: 构建和维护 Serena Memories  
**触发**: `@serena-maintenance`（智能模式）或指定操作

**核心内容**:
- 智能自动评估流程（4 步）
- Memory 文件结构规范
- 标准模板（project_overview、tech_stack、common_patterns）
- 质量审计清单

**可复用性**: ✅ 完全可跨项目复用

---

### 5. `XcodeMCP/xcode-build.mdc`（112 行）❌ 按需触发

**用途**: Xcode 构建和运行工具  
**触发**: `@xcode-build`  
**功能**: 构建、运行、测试 iOS 应用（支持模拟器和真机）

**可复用性**: ✅ 通用 iOS 项目可复用

---

### 6. `XcodeMCP/xcode-log.mdc`（414 行）❌ 按需触发

**用途**: Xcode 日志捕获和分析  
**触发**: `@xcode-log`  
**功能**: 实时日志监控、错误分析、日志过滤

**可复用性**: ✅ 通用 iOS 项目可复用

---

## 🎭 职责划分

### Cursor Rules（本目录）
- ✅ 个人编码偏好和工作方式
- ✅ Serena MCP 工作流程和工具规范
- ✅ 设计原则与项目约束（可执行指令）
- ✅ 问题处理指南（提供思路，不直接解决）
- ✅ Memory 维护指南（详细，按需加载）
- ✅ 开发工具指南（快捷构建命令等）

### Serena Memories（`.serena/memories/`）
- ✅ 项目详细信息（project_overview.md）
- ✅ 技术栈使用详情（tech_stack.md）
- ✅ 代码模式和示例（common_patterns.md）
- ⚠️ Troubleshooting 由用户手动维护（非 AI 生成）

**关键区别**: 
- **Cursor Rules** = 规范、指导、工作流程（如何做）
- **Serena Memories** = 项目知识、技术细节（是什么）

---

## ✨ 规则体系优势

1. **精简高效**: Always 规则仅 175 行，token 占用极低
2. **智能触发**: 自动识别项目任务，强制加载 Serena memories
3. **可执行指令**: 设计原则配合具体执行规则，AI 能真正遵守
4. **详细指导**: 工具规则 1819 行，提供完整参考和决策树
5. **清晰分层**: 核心规则（always）vs 工具规则（按需）vs XcodeMCP 工具
6. **高复用性**: 85% 的规则可直接复用到新项目
7. **易于维护**: 职责清晰，结构分明
8. **按需加载**: 工具规则仅在需要时触发，不占用常规对话 token
9. **持续优化**: 规则编写指南确保规则质量
10. **问题处理合集**: 收集 AI 常见错误场景，持续提高精准度

---

## 🚀 应用到新项目

### ✅ 完全复用（无需修改）
- `00-personal.mdc` - 个人编码偏好
- `01-serena-workflow.mdc` - Serena 工作流程
- `tools/` 目录下所有工具规则

### ⚠️ 需要定制
**`02-project-conventions.mdc`**：根据新项目调整以下内容
- **编码流程**：保持不变（SRP/OCP/DIP 分析）
- **设计原则**：保持不变（SOLID 原则和执行指令）
- **强制约束**：根据项目架构调整：
  - 分层规则（Controller/Request/View）
  - 禁止项（根据技术栈调整）
  - 类名前缀（如 SS → 改为新项目前缀）

### 🔧 初始化步骤

1. **复制规则文件**
   ```bash
   cp -r .cursor/rules/ /path/to/newproject/.cursor/
   ```

2. **调整项目约定**
   ```bash
   vim /path/to/newproject/.cursor/rules/02-project-conventions.mdc
   # 更新强制约束中的项目特定内容
   ```

3. **配置 Serena MCP**
   - 确保新项目已配置 Serena MCP 服务器
   - AI 会自动检测服务器名称（无需修改规则）

4. **构建项目记忆**
   ```
   @serena-maintenance  # 智能模式创建 memories
   ```

---

## 📊 规则统计

### 核心规则（Always）
| 文件 | 行数 | 用途 |
|------|------|------|
| `00-personal.mdc` | 57 | 个人编码偏好 |
| `01-serena-workflow.mdc` | 65 | Serena 工作流程 |
| `02-project-conventions.mdc` | 53 | 设计原则与约束 |
| **核心规则总计** | **175** | **Always 加载** |

### 工具规则（按需）
| 文件 | 行数 | 用途 |
|------|------|------|
| `tools/api-integration.mdc` | ~500 | 接口对接规范 |
| `tools/problem-handling.mdc` | 32 | 问题处理合集 |
| `tools/quick-build.mdc` | 50 | 快捷构建命令 |
| `tools/rules-maintenance.mdc` | 436 | 规则编写指南 |
| `tools/serena-maintenance.mdc` | 775 | Memory 维护 |
| **工具规则总计** | **~1793** | **按需触发** |

### XcodeMCP 工具（按需）
| 文件 | 行数 | 用途 |
|------|------|------|
| `XcodeMCP/xcode-build.mdc` | 112 | 构建和运行 |
| `XcodeMCP/xcode-log.mdc` | 414 | 日志分析 |
| **XcodeMCP 总计** | **526** | **按需触发** |

**总计**: ~2494 行
- Always 规则: 175 行（精简高效，占 7.0%）
- 工具规则: ~1793 行（详细完整，占 71.9%）
- XcodeMCP 工具: 526 行（专用工具，占 21.1%）

---

## 📖 使用指南

### 日常开发
核心规则自动加载，无需手动触发：
- 编码时遵循设计原则（02 文件会强制 AI 分析）
- 操作代码时自动加载 Serena memories

### 快速构建
```bash
@quick-build      # 重启模拟器并运行应用
@xcode-build      # 使用 Xcode MCP 构建
```

### 维护工具
```bash
@api-integration         # 接口对接规范（UI 完成后接接口时）
@serena-maintenance      # 维护项目记忆（智能模式）
@rules-maintenance       # 优化规则文件
@problem-handling        # 问题排查指导
```

### 日志分析
```bash
@xcode-log        # 查看和分析 Xcode 日志
```

---

## 📝 版本历史

### v3.5 - 2025-11-06
**主题**: 问题处理合集建立与规则维护指南扩充

- ✅ **重构 problem-handling.mdc**（10 行 → 32 行）
  - 明确定位：错误处理合集（双重用途：AI 精准度 + 用户查阅）
  - 新增"与 AI 沟通技术术语"章节
  - 核心建议 + 术语对照表 + 关键提醒
  - 消除模糊词汇，适合持续扩展
- ✅ **扩充 rules-maintenance.mdc**（187 行 → 436 行）
  - 新增案例 3：问题处理合集精简示例
  - 版本更新至 2.1
  - 明确用户参考文件的定位和优化原则
- ✅ **全面更新 README.md**
  - 同步所有文件实际行数（Always: 152→175, 工具: 1396→1293, XcodeMCP: 482→526）
  - 更新 problem-handling.mdc 描述为"问题处理合集"
  - 扩充 rules-maintenance.mdc 内容说明
  - 新增第 10 条优势：问题处理合集

**改进动机**: 建立问题处理合集机制，持续收集 AI 常见错误和解决方案，提高 AI 处理精准度

---

### v3.4 - 2025-10-31
**主题**: 规则精简与新增规则编写指南

- ✅ **大幅精简核心规则**（198 行 → 152 行）
  - 01-serena-workflow.mdc：112 行 → 65 行（减少 42%）
  - 删除冗余内容，保留核心要点
- ✅ **新增 rules-maintenance.mdc**（187 行）
  - 规则编写与优化指南
  - 三大核心原则：可执行性、混合式设计、精简
  - 规则质量检查清单
- ✅ **优化 serena-maintenance.mdc**（1217 行 → 1149 行）
  - 精简使用示例
  - 优化常见问题（8 个 → 5 个）
- ✅ **发现并记录 XcodeMCP 目录**
  - xcode-build.mdc（112 行）
  - xcode-log.mdc（370 行）
- ✅ **全面更新 README.md**
  - 更新所有文件行数统计
  - 添加 XcodeMCP 工具说明
  - 更新使用指南

**改进动机**: Always 规则从 198 行精简到 152 行，降低 token 占用；新增规则编写指南确保规则质量

---

### v3.3 - 2025-10-31
**主题**: 设计原则可执行化与规则重构

- ✅ **02 文件重大升级**（6 行 → 53 行）
  - 新增"编码流程"：强制 AI 在编码前分析设计原则
  - 设计原则混合式：抽象原则 + 具体执行指令
  - 新增强制约束：明确禁止/推荐项
- ✅ **README.md 全面重构**
  - 更新所有文件行数统计（准确反映当前状态）
  - 精简文件结构说明，增加 emoji 提升可读性
  - 移除不存在的 xcode-*.mdc 文件说明
  - 重写核心规则和工具规则详解
  - 优化跨项目复用指南
- ✅ **规则可执行性提升**
  - 从纯抽象原则转变为"原则 + 可执行指令"
  - AI 能真正检查并遵守设计原则
  - 提供分层架构的明确约束

**改进动机**: 抽象设计原则难以被 AI 执行，需要转化为具体可检查的指令

---

### v3.2 - 2025-10-30
**主题**: 规则通用化与 Serena MCP 强制使用

- ✅ **规则通用化改造**
  - 移除硬编码项目名称（`next1` → `{项目名}`）
  - AI 自动检测 Serena MCP 服务器名称
  - 规则可跨项目直接复用
- ✅ **强制 Serena MCP 使用**
  - 新增"步骤 3：使用 Serena MCP 工具探索代码"
  - 🚨 严格禁止直接 `read_file` 读取代码文件
  - 明确探索阶段与编辑阶段的工具选择
- ✅ **新增工具决策树**
  - 清晰的场景 → 工具映射表
  - 标注禁止使用的工具
  - 提供正确/错误工作流示例
- ✅ **完善初始化流程**
  - 新增 `initial_instructions` 和 `check_onboarding_performed`
  - 明确 6 步初始化检查清单
- ✅ **自我验证增强**
  - 新增"是否优先使用符号化工具"检查项
  - 检查清单从 4 项扩展到 7 项

**改进动机**: 用户反馈 AI 未充分使用 Serena MCP，直接使用 `read_file` 和 `grep` 导致效率低下

### v3.1 - 2025-10-29
**主题**: 强化规则触发机制

- ✅ 增强 `00-personal.mdc`
  - 新增 📋 强制检查清单（项目任务自动触发）
  - 简化检查流程（只保留核心项目上下文加载）
- ✅ 重写 `01-serena-workflow.mdc`
  - 新增 🎯 执行条件（明确的技术代码指标判断）
  - 新增 ⚡ 强制步骤（命令式语言，必须执行）
  - 新增 ✅ 自我验证（回复前确认机制）
- ✅ 更新 README.md（反映规则简化）

### v3.0 - 2025-10-28
**主题**: 强化编码规范，完善文档体系

- ✅ 扩展 `00-personal.mdc` 编码规范
  - 新增工作方式指导（先思考再实现、逐步推理）
  - 新增代码质量要求（100%完整、可读性优先）
  - 新增诚信原则（明确不确定性、不猜测）
- ✅ 重构 README.md
  - 优化文档结构和层次
  - 完善工具规则说明
  - 新增使用建议章节

### v2.0 - 2025-10-24
**主题**: 规则体系重构与职责划分

- ✅ 确立核心原则（Always 简洁 / 按需详细）
- ✅ 规则文件组织
  - 核心规则 4 个（~94 行，始终加载）
  - 工具规则移至 `tools/` 子目录（~1316 行，按需触发）
- ✅ 职责清晰化
  - Cursor Rules：规范和指导
  - Serena Memories：项目知识
- ✅ 新增 `03-problem-handling.mdc`（AI 提供思路，不直接解决）
- ✅ Serena Maintenance 智能化（支持自动判断操作）

### v1.0 - 2025-10-20
**主题**: 初始化规则体系

- ✅ 创建基础规则文件
  - `00-personal.mdc`：个人偏好配置
  - `01-serena-workflow.mdc`：Serena 工作流程
  - `02-project-conventions.mdc`：项目约定
- ✅ 引入 Serena MCP 支持
- ✅ 创建工具规则
  - Xcode 工具集（build/log/ui）
  - Quick Build 快捷命令
  - Serena Maintenance 维护指南
- ✅ 建立 README.md 文档体系

---

## 💡 维护原则

1. **Always 规则精简高效**：单文件 < 70 行，总计 < 180 行
2. **可执行性优先**：抽象原则必须配合具体执行指令
3. **强制触发机制**：项目任务自动加载 Serena memories
4. **工具规则可详细**：按需触发，提供完整参考和决策树
5. **定期审查更新**：保持规则与项目实际情况同步
6. **跨项目复用**：通用规则无需修改，项目特定规则需调整
7. **使用编写指南**：参考 `@rules-maintenance` 确保规则质量
8. **问题处理合集**：持续收集 AI 常见错误和解决方案

---

**最后更新**: 2025-01-XX（新增接口对接规范）
